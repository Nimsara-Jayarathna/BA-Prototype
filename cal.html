<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Sales Report</title>
  <style>
    /* CRITICAL CHANGE: The body height is simplified for better iframe behavior */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f2f2f7; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
    .header-nav { display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; background-color: #fff; border-bottom: 1px solid #d1d1d6; flex-shrink: 0; }
    .header-nav button { background: none; border: none; font-size: 18px; cursor: pointer; color: #007aff; padding: 5px 10px; border-radius: 8px; transition: background-color 0.2s; }
    .header-nav button:active { background-color: #e5e5ea; }
    .main-content { flex: 1; overflow-y: auto; padding: 20px; }
    .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; background-color: #d1d1d6; padding: 10px; border-top: 1px solid #ccc; flex-shrink: 0; }
    .keypad button { background-color: #fff; border: none; font-size: 20px; padding: 12px 0; text-align: center; color: #000; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.1s ease-in-out; }
    .keypad button:active { background-color: #e5e5ea; box-shadow: 0 1px 2px rgba(0,0,0,0.1); transform: translateY(1px); }
    #backspace-btn { background-color: #d1d1d6; font-size: 24px; color: #555; }
    #backspace-btn svg { width: 28px; height: 28px; vertical-align: middle; pointer-events: none; }
    .transaction-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 16px; background-color: #f2f2f7; flex-shrink: 0; }
    .transaction-controls button { background-color: #fff; border: none; font-size: 18px; padding: 16px 0; text-align: center; font-weight: 600; border-radius: 10px; box-shadow: 0 3px 5px rgba(0,0,0,0.1); transition: all 0.1s ease-in-out; }
    .transaction-controls button:active { box-shadow: 0 1px 2px rgba(0,0,0,0.1); transform: translateY(1px); }
    .income { color: #34c759 !important; }
    .expense { color: #ff3b30 !important; }
    .display { display: flex; justify-content: space-between; align-items: center; background-color: #fff; padding: 16px; text-align: right; font-size: 40px; font-weight: 300; border-bottom: 1px solid #d1d1d6; flex-shrink: 0; overflow-x: auto; white-space: nowrap; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); }
    #expression-display { font-size: 20px; color: #888; margin-right: 10px; flex-grow: 1; text-align: left; }
    .keypad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; background-color: #d1d1d6; padding: 10px; border-top: 1px solid #ccc; flex-shrink: 0; }
    .keypad .operator-btn { background-color: #ff9500; color: white; font-size: 24px; }
    .transaction-list { padding: 0; margin: 0; list-style: none; }
    .transaction-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #e5e5ea; }
    .transaction-list li span:first-child { flex-grow: 1; }
    .transaction-list li span:last-child { text-align: right; min-width: 90px; }
    .undo-btn { background: none; border: none; font-size: 18px; color: #007aff; padding: 5px 10px; border-radius: 8px; transition: background-color 0.2s; }
    .undo-btn:active { background-color: #e5e5ea; }
    .undo-btn:disabled { color: #d1d1d6; }
    .category-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .category-modal { background-color: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .category-modal h3 { margin-top: 0; margin-bottom: 15px; font-size: 20px; text-align: center; }
    .category-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
    .category-buttons button { padding: 12px; font-size: 16px; border: 1px solid #d1d1d6; border-radius: 8px; background-color: #f9f9f9; cursor: pointer; transition: background-color 0.2s; }
    .category-modal .cancel-btn { width: 100%; padding: 12px; font-size: 16px; background-color: #ccc; color: #333; border: none; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body>

  <!-- CRITICAL CHANGE: Header buttons now call the parent window's functions correctly -->
  <div class="header-nav">
    <button onclick="window.parent.loadTab('reports.html', window.parent.document.getElementById('nav-reports'))">üìä Reports</button>
    <button onclick="window.parent.loadTab('settings.html', window.parent.document.getElementById('nav-settings'))">‚öôÔ∏è Settings</button>
    <button class="undo-btn" id="undo-btn" onclick="undoLastTransaction()">Undo</button>
  </div>

  <div class="main-content"> <ul class="transaction-list" id="transaction-list"></ul> </div>
  <div class="display">
    <span id="expression-display"></span>
    <span id="amount">0</span>
  </div>
  <div class="transaction-controls">
    <button class="income" id="income-btn">Income</button>
    <button class="expense" id="expense-btn">Expense</button>
  </div>
  <div class="keypad">
    <button onclick="appendNumber('1')">1</button>
    <button onclick="appendNumber('2')">2</button>
    <button onclick="appendNumber('3')">3</button>
    <button class="operator-btn" onclick="handleOperator('+')">+</button>
    <button onclick="appendNumber('4')">4</button>
    <button onclick="appendNumber('5')">5</button>
    <button onclick="appendNumber('6')">6</button>
    <button class="operator-btn" onclick="handleOperator('-')">‚àí</button>
    <button onclick="appendNumber('7')">7</button>
    <button onclick="appendNumber('8')">8</button>
    <button onclick="appendNumber('9')">9</button>
    <button class="operator-btn" onclick="handleOperator('*')">√ó</button>
    <button onclick="appendNumber('.')">.</button>
    <button onclick="appendNumber('0')">0</button>
    <button id="backspace-btn">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M22 3H7c-.69 0-1.23.35-1.59.88L0 12l5.41 8.11c.36.53.9.89 1.59.89h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-3 12.59L17.59 17 14 13.41 10.41 17 9 15.59 12.59 12 9 8.41 10.41 7 14 10.59 17.59 7 19 8.41 15.41 12 19 15.59z"></path>
      </svg>
    </button>
    <button class="operator-btn" onclick="handleOperator('/')">√∑</button>
  </div>
  <div class="category-overlay" id="category-overlay" style="display: none;">
    <div class="category-modal">
      <h3 id="category-modal-title">Select Category</h3>
      <div class="category-buttons" id="category-buttons"></div>
      <button class="cancel-btn" onclick="hideCategorySelection()">Cancel</button>
    </div>
  </div>

  <script>
    const amountDisplay = document.getElementById('amount');
    const expressionDisplay = document.getElementById('expression-display');
    const transactionList = document.getElementById('transaction-list');
    const undoBtn = document.getElementById('undo-btn');
    const categoryOverlay = document.getElementById('category-overlay');
    const categoryModalTitle = document.getElementById('category-modal-title');
    const categoryButtonsContainer = document.getElementById('category-buttons');
    const incomeBtn = document.getElementById('income-btn');
    const expenseBtn = document.getElementById('expense-btn');
    const backspaceBtn = document.getElementById('backspace-btn');

    const CURRENCY_SYMBOL = 'LKR';
    let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
    let lastTransactionIdForUndo = null;

    // Calculator state
    let currentAmount = '0';
    let firstOperand = null;
    let operator = null;
    let waitingForSecondOperand = false;
    let calculationCompleted = false;

    const LONG_PRESS_THRESHOLD = 500;
    let longPressTimer;
    let isLongPress = false;

    function backspace() {
      if (calculationCompleted) return; // Don't allow backspace on a result
      if (currentAmount.length > 1) {
        currentAmount = currentAmount.slice(0, -1);
      } else {
        currentAmount = '0';
      }
      updateDisplay();
    }

    function getLocalDateString() { const now = new Date(); return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`; }
    
    function getTypes(type) {
        const defaultTypes = { income: ['Sales'], expense: ['Stock'] };
        const storedTypes = JSON.parse(localStorage.getItem(`${type}Types`));
        return (storedTypes && storedTypes.length > 0) ? storedTypes : defaultTypes[type];
    }

    function appendNumber(number) {
        if (calculationCompleted) {
            clearAmount();
        }
        if (waitingForSecondOperand) {
            currentAmount = '';
            waitingForSecondOperand = false;
        }
        if (currentAmount === '0' && number !== '.') currentAmount = '';
        if (number === '.' && currentAmount.includes('.')) return;
        
        currentAmount += number;
        calculationCompleted = false;
        updateDisplay();
    }

    function clearAmount() {
        currentAmount = '0';
        firstOperand = null;
        operator = null;
        waitingForSecondOperand = false;
        calculationCompleted = false;
        expressionDisplay.textContent = '';
        updateDisplay();
    }

    function updateDisplay() {
        amountDisplay.textContent = currentAmount;
        if (!calculationCompleted) {
            expressionDisplay.textContent = operator ? `${firstOperand} ${operator}` : '';
        }
    }

    function handleOperator(selectedOperator) {
        if (operator && !waitingForSecondOperand) {
            performCalculation();
        }
        firstOperand = parseFloat(currentAmount);
        operator = selectedOperator;
        waitingForSecondOperand = true;
        calculationCompleted = false;
        updateDisplay();
    }

    function performCalculation() {
        if (operator === null || waitingForSecondOperand) {
            return parseFloat(currentAmount);
        }

        const secondOperand = parseFloat(currentAmount);
        let result = 0;

        if (isNaN(firstOperand) || isNaN(secondOperand)) return NaN;

        if (operator === '+') result = firstOperand + secondOperand;
        else if (operator === '-') result = firstOperand - secondOperand;
        else if (operator === '*') result = firstOperand * secondOperand;
        else if (operator === '/') result = firstOperand / secondOperand;
        
        const resultString = String(parseFloat(result.toFixed(5)));
        const shortExpression = `${firstOperand} ${operator} ${secondOperand}`;
        const fullExpression = `${shortExpression} = ${resultString}`;

        if (fullExpression.length > 40) {
            expressionDisplay.textContent = shortExpression;
        } else {
            expressionDisplay.textContent = fullExpression;
        }

        currentAmount = resultString;
        amountDisplay.textContent = currentAmount;

        // Set state for chained calculations
        firstOperand = result;
        operator = null;
        waitingForSecondOperand = false;
        calculationCompleted = true;

        return result;
    }

    function startPress(type) { isLongPress = false; longPressTimer = setTimeout(() => { isLongPress = true; showCategorySelection(type); }, LONG_PRESS_THRESHOLD); }
    function endPress(type) { clearTimeout(longPressTimer); if (!isLongPress) { confirmTransaction(type, `General ${type.charAt(0).toUpperCase() + type.slice(1)}`); } }

    incomeBtn.addEventListener('mousedown', () => startPress('income'));
    incomeBtn.addEventListener('mouseup', () => endPress('income'));
    expenseBtn.addEventListener('mousedown', () => startPress('expense'));
    expenseBtn.addEventListener('mouseup', () => endPress('expense'));
    incomeBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startPress('income'); }, { passive: false });
    incomeBtn.addEventListener('touchend', () => endPress('income'));
    expenseBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startPress('expense'); }, { passive: false });
    expenseBtn.addEventListener('touchend', () => endPress('expense'));
    
    backspaceBtn.addEventListener('mousedown', () => { isLongPress = false; longPressTimer = setTimeout(() => { isLongPress = true; clearAmount(); }, LONG_PRESS_THRESHOLD); });
    backspaceBtn.addEventListener('mouseup', () => { clearTimeout(longPressTimer); if (!isLongPress) { backspace(); } });
    backspaceBtn.addEventListener('touchstart', (e) => { e.preventDefault(); isLongPress = false; longPressTimer = setTimeout(() => { isLongPress = true; clearAmount(); }, LONG_PRESS_THRESHOLD); }, { passive: false });
    backspaceBtn.addEventListener('touchend', () => { clearTimeout(longPressTimer); if (!isLongPress) { backspace(); } });

    function showCategorySelection(type) {
      let amount = parseFloat(currentAmount);
      if (operator && !waitingForSecondOperand) {
        const secondOperand = parseFloat(currentAmount);
        if (operator === '+') amount = firstOperand + secondOperand;
        else if (operator === '-') amount = firstOperand - secondOperand;
        else if (operator === '*') amount = firstOperand * secondOperand;
        else if (operator === '/') amount = firstOperand / secondOperand;
      }
      
      if (isNaN(amount) || amount === 0) { alert("Please enter an amount or complete the calculation first."); return; }
      
      categoryModalTitle.textContent = `Select ${type === 'income' ? 'Income' : 'Expense'} Category`;
      categoryButtonsContainer.innerHTML = '';
      const types = getTypes(type);
      types.forEach(cat => {
        const button = document.createElement('button');
        button.textContent = cat;
        button.onclick = () => confirmTransaction(type, cat);
        categoryButtonsContainer.appendChild(button);
      });
      categoryOverlay.style.display = 'flex';
    }

    function hideCategorySelection() { categoryOverlay.style.display = 'none'; }
    
    function confirmTransaction(type, category) {
        const amount = performCalculation();

        if (isNaN(amount) || amount <= 0) {
            // Maybe the user just entered a number without calculation
            const singleAmount = parseFloat(currentAmount);
            if (isNaN(singleAmount) || singleAmount <= 0) {
                clearAmount();
                return;
            }
            // If it was a valid single number, create the transaction
            const transaction = { id: Date.now(), type, amount: singleAmount, category, date: getLocalDateString(), time: new Date().toLocaleTimeString(), status: 'active' };
            lastTransactionIdForUndo = transaction.id;
            transactions.push(transaction);
        } else {
            // If a calculation was performed, use that amount
            const transaction = { id: Date.now(), type, amount, category, date: getLocalDateString(), time: new Date().toLocaleTimeString(), status: 'active' };
            lastTransactionIdForUndo = transaction.id;
            transactions.push(transaction);
        }

        localStorage.setItem('transactions', JSON.stringify(transactions));
        clearAmount();
        renderTransactions();
        updateUndoButton();
        hideCategorySelection();
        const btn = document.querySelector(`.${type}`);
        btn.style.backgroundColor = type === 'income' ? '#d4edda' : '#f8d7da';
        setTimeout(() => { btn.style.backgroundColor = '#fff'; }, 300);
    }

    function undoLastTransaction() { if (!lastTransactionIdForUndo) return; const transactionToUndo = transactions.find(t => t.id === lastTransactionIdForUndo); if (transactionToUndo) { transactionToUndo.status = 'undone'; lastTransactionIdForUndo = null; localStorage.setItem('transactions', JSON.stringify(transactions)); renderTransactions(); updateUndoButton(); alert('Last transaction undone.'); } }
    function renderTransactions() { transactionList.innerHTML = ''; const todayTransactions = transactions.filter(t => t.date === getLocalDateString() && t.status === 'active').sort((a, b) => b.id - a.id); for (const transaction of todayTransactions) { const li = document.createElement('li'); li.className = transaction.type; li.innerHTML = `<span>${transaction.time} - ${transaction.category}</span><span>${CURRENCY_SYMBOL} ${transaction.amount.toFixed(2)}</span>`; transactionList.appendChild(li); } }
    function updateUndoButton() { undoBtn.disabled = !lastTransactionIdForUndo; }
    document.addEventListener('DOMContentLoaded', () => { renderTransactions(); lastTransactionIdForUndo = null; updateUndoButton(); });
  </script>
</body>
</html>