<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reports</title>
  <style>
    /* CSS is unchanged */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f2f2f7; margin: 0; padding: 20px; }
    .reports-section { background-color: #fff; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    .reports-section h2 { margin-top: 0; font-size: 22px; font-weight: 600; border-bottom: 1px solid #e5e5ea; padding-bottom: 10px; margin-bottom: 15px; }
    .date-picker, .month-picker { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #d1d1d6; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
    .report-btn, .download-btn { width: 100%; padding: 15px; font-size: 18px; color: #fff; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; }
    .generate-daily-btn { background-color: #007aff; }
    .generate-monthly-btn { background-color: #5856d6; }
    .download-btn { background-color: #34c759; display: none; }
    .loading-indicator { display: none; text-align: center; margin-top: 10px; font-size: 16px; color: #555; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

  <div class="reports-section">
    <h2>Daily Report</h2>
    <input type="date" id="report-date" class="date-picker">
    <button class="report-btn generate-daily-btn" id="generate-daily-btn" onclick="generateDailyReport()">Generate Daily PDF</button>
    <button class="download-btn" id="download-daily-btn">Download Daily Report</button>
  </div>

  <div class="reports-section">
    <h2>Monthly Report</h2>
    <input type="month" id="report-month" class="month-picker">
    <button class="report-btn generate-monthly-btn" id="generate-monthly-btn" onclick="generateMonthlyReport()">Generate Monthly Summary PDF</button>
    <button class="download-btn" id="download-monthly-btn">Download Monthly Report</button>
  </div>
  
  <div class="loading-indicator" id="loading-indicator">Generating report...</div>

  <script>
    const { jsPDF } = window.jspdf;
    let transactions = JSON.parse(localStorage.getItem('transactions')) || [];

    const CURRENCY_SYMBOL = 'LKR';
    const LOGO_BASE64 = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAoHBwgHBgoICAgLCgoLDhgQDg0NDh0VFhEYIx8lJCIfIiEmKzcvJik0KSEiMEExNDk7Pj4+JS5ESUM8SDc9Pjv/2wBDAQoLCw4NDhwQEBw7KCIoOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozv/wAARCAAQABADASIAAhEBAxEB/8QAGQAAAwEBAQAAAAAAAAAAAAAAAAIDAQQF/8QAIxAAAQMDBAIDAAAAAAAAAAAAAQIDEQAEIRIxBUEiMlFhcP/EABYBAQEBAAAAAAAAAAAAAAAAAAABBf/EABwRAQEBAAIDAQAAAAAAAAAAAAABEQISAyExQf/aAAwDAQACEQMRAD8A6q2t5XqKkSryTCSOU1Zq3+KHEoSCpQAgc1PikONpWhQUhQkKBmQaB2s/aC4W3i4klS/kCBPwTQet7+ZfSgtqKUJ/UUgz9yaZpa2qQpISk5EpGYE8Gg7G0S2G0obSEISIAHAFQ3//2Q==';

    const dailyBtn = document.getElementById('generate-daily-btn');
    const monthlyBtn = document.getElementById('generate-monthly-btn');
    const downloadDailyBtn = document.getElementById('download-daily-btn');
    const downloadMonthlyBtn = document.getElementById('download-monthly-btn');
    const loadingIndicator = document.getElementById('loading-indicator');

    const COLOR_INCOME = [52, 199, 89];
    const COLOR_EXPENSE = [255, 59, 48];
    const COLOR_BLACK = [33, 33, 33];
    const COLOR_GRAY = [150, 150, 150];
    const COLOR_LINE = [229, 229, 234];

    const PAGE_MARGIN = 15;
    const PAGE_WIDTH = 210;
    const PAGE_HEIGHT = 297;

    function showLoading() { /* Unchanged */ loadingIndicator.style.display = 'block'; dailyBtn.disabled = true; monthlyBtn.disabled = true; downloadDailyBtn.style.display = 'none'; downloadMonthlyBtn.style.display = 'none'; }
    function hideLoading() { /* Unchanged */ loadingIndicator.style.display = 'none'; dailyBtn.disabled = false; monthlyBtn.disabled = false; }
    function downloadPdf(blob, fileName) { /* Unchanged */ const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
    
    function drawPageHeader(doc, title, date) { /* Unchanged */ doc.addImage(LOGO_BASE64, 'JPEG', PAGE_MARGIN, 15, 20, 20); doc.setFontSize(24); doc.setFont('helvetica', 'bold'); doc.setTextColor(...COLOR_BLACK); doc.text(title, PAGE_WIDTH / 2, 20, { align: 'center' }); doc.setFontSize(14); doc.setFont('helvetica', 'normal'); doc.text(`Date: ${date}`, PAGE_WIDTH / 2, 28, { align: 'center' }); return 40; }

    // --- UPDATED: drawSummaryPage with precise currency alignment ---
    function drawSummaryPage(doc, title, summaryData) {
        doc.addPage();
        let y = drawPageHeader(doc, title, summaryData.date);
        
        doc.setDrawColor(...COLOR_LINE);
        doc.line(PAGE_MARGIN, y, PAGE_WIDTH - PAGE_MARGIN, y);
        y += 15;
        
        doc.setFontSize(16); doc.setFont('helvetica', 'bold'); doc.setTextColor(...COLOR_BLACK);
        doc.text('Summary:', PAGE_MARGIN, y); y += 10;

        const currencyX = 160; // X position for the LKR symbol
        const valueX = 195;     // X position for the right-aligned number

        doc.setFontSize(12); doc.setFont('helvetica', 'normal');
        doc.setTextColor(...COLOR_BLACK);
        doc.text('Total Income:', PAGE_MARGIN + 5, y);
        doc.setTextColor(...COLOR_INCOME);
        doc.text(CURRENCY_SYMBOL, currencyX, y); // Split symbol and value
        doc.text(summaryData.totalIncome.toFixed(2), valueX, y, { align: 'right' });
        y += 7;
        
        doc.setTextColor(...COLOR_BLACK);
        doc.text('Total Expenses:', PAGE_MARGIN + 5, y);
        doc.setTextColor(...COLOR_EXPENSE);
        doc.text(CURRENCY_SYMBOL, currencyX, y); // Split symbol and value
        doc.text(summaryData.totalExpenses.toFixed(2), valueX, y, { align: 'right' });
        y += 10;

        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...COLOR_BLACK);
        doc.text('Net Profit/Loss:', PAGE_MARGIN + 5, y);
        const netProfit = summaryData.totalIncome - summaryData.totalExpenses;
        doc.setTextColor(...(netProfit >= 0 ? COLOR_INCOME : COLOR_EXPENSE));
        doc.text(CURRENCY_SYMBOL, currencyX, y); // Split symbol and value
        doc.text(netProfit.toFixed(2), valueX, y, { align: 'right' });
        y += 10;

        doc.setFont('helvetica', 'normal'); doc.setTextColor(...COLOR_BLACK);
        doc.text('Active Transactions:', PAGE_MARGIN + 5, y);
        doc.text(`${summaryData.activeCount}`, valueX, y, { align: 'right' });
        y += 7;
        doc.text('Cancelled Transactions:', PAGE_MARGIN + 5, y);
        doc.text(`${summaryData.cancelledCount}`, valueX, y, { align: 'right' });
        y += 15;

        doc.line(PAGE_MARGIN, y, PAGE_WIDTH - PAGE_MARGIN, y); y += 10;

        doc.setFontSize(16); doc.setFont('helvetica', 'bold'); doc.setTextColor(...COLOR_BLACK);
        doc.text('Category Breakdown:', PAGE_MARGIN, y); y += 10;

        doc.setFontSize(12); doc.setFont('helvetica', 'normal');
        doc.setTextColor(...COLOR_INCOME);
        doc.text('Income by Category:', PAGE_MARGIN + 5, y); y += 7;
        for (const category in summaryData.incomeByCategory) {
            doc.setTextColor(...COLOR_BLACK);
            doc.text(category, PAGE_MARGIN + 10, y);
            doc.setTextColor(...COLOR_INCOME);
            doc.text(CURRENCY_SYMBOL, currencyX, y); // Split symbol and value
            doc.text(summaryData.incomeByCategory[category].toFixed(2), valueX, y, { align: 'right' });
            y += 7;
        }
        y += 5;
        doc.setTextColor(...COLOR_EXPENSE);
        doc.text('Expenses by Category:', PAGE_MARGIN + 5, y); y += 7;
        for (const category in summaryData.expenseByCategory) {
            doc.setTextColor(...COLOR_BLACK);
            doc.text(category, PAGE_MARGIN + 10, y);
            doc.setTextColor(...COLOR_EXPENSE);
            doc.text(CURRENCY_SYMBOL, currencyX, y); // Split symbol and value
            doc.text(summaryData.expenseByCategory[category].toFixed(2), valueX, y, { align: 'right' });
            y += 7;
        }
        doc.setTextColor(...COLOR_BLACK);
    }
    
    function addFooter(doc) { /* Unchanged */ const pageCount = doc.internal.getNumberOfPages(); for (let i = 1; i <= pageCount; i++) { doc.setPage(i); doc.setFontSize(10); doc.setTextColor(...COLOR_GRAY); if (i === pageCount) { doc.text(`Report Generated On: ${new Date().toLocaleString()}`, PAGE_MARGIN, PAGE_HEIGHT - 10); } } }

    // --- UPDATED: generateDailyReport with precise currency alignment ---
    function generateDailyReport() {
        const reportDate = document.getElementById('report-date').value;
        if (!reportDate) { alert('Please select a date.'); return; }
        showLoading();
        
        transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        const dailyTransactions = transactions.filter(t => t.date === reportDate);
        if (dailyTransactions.length === 0) { alert('No transactions for the selected date.'); hideLoading(); return; }
        
        const summaryData = { date: reportDate, totalIncome: 0, totalExpenses: 0, activeCount: 0, cancelledCount: 0, incomeByCategory: {}, expenseByCategory: {} };
        dailyTransactions.forEach(t => { if (t.status === 'undone') { summaryData.cancelledCount++; } else { summaryData.activeCount++; if (t.type === 'income') { summaryData.totalIncome += t.amount; summaryData.incomeByCategory[t.category] = (summaryData.incomeByCategory[t.category] || 0) + t.amount; } else { summaryData.totalExpenses += t.amount; summaryData.expenseByCategory[t.category] = (summaryData.expenseByCategory[t.category] || 0) + t.amount; } } });
        
        const doc = new jsPDF();
        let y = drawPageHeader(doc, 'Daily Financial Report', reportDate);
        doc.setDrawColor(...COLOR_LINE); doc.line(PAGE_MARGIN, y, PAGE_WIDTH - PAGE_MARGIN, y); y += 5;
        
        doc.setFontSize(16); doc.setFont('helvetica', 'bold'); doc.setTextColor(...COLOR_BLACK);
        doc.text('Transactions:', PAGE_MARGIN, y); y += 8;

        // Define separate coordinates for currency and value
        const cols = { time: 20, cat: 50, type: 110, amt_currency: 160, amt_value: 195 };
        const drawTableHeader = () => {
            doc.setFontSize(10); doc.setFont('helvetica', 'bold'); doc.setTextColor(...COLOR_BLACK);
            doc.text('Time', cols.time, y); doc.text('Category', cols.cat, y); doc.text('Type', cols.type, y);
            doc.text('Amount', cols.amt_value, y, { align: 'right' }); // Header aligns with number
            doc.line(PAGE_MARGIN, y + 2, PAGE_WIDTH - PAGE_MARGIN, y + 2); y += 7;
        };
        drawTableHeader();
        
        dailyTransactions.forEach(t => {
            if (y > PAGE_HEIGHT - PAGE_MARGIN) { doc.addPage(); y = drawPageHeader(doc, 'Daily Financial Report', reportDate); drawTableHeader(); }
            const isUndone = t.status === 'undone';
            const color = isUndone ? COLOR_GRAY : (t.type === 'income' ? COLOR_INCOME : COLOR_EXPENSE);
            doc.setTextColor(...color); doc.setFont('helvetica', 'normal');
            doc.text(t.time, cols.time, y);
            doc.text(t.category, cols.cat, y);
            doc.text(t.type.toUpperCase() + (isUndone ? ' (CANCELLED)' : ''), cols.type, y);
            
            // Draw currency and value separately for alignment
            doc.text(CURRENCY_SYMBOL, cols.amt_currency, y);
            doc.text(t.amount.toFixed(2), cols.amt_value, y, { align: 'right' });
            
            if (isUndone) { const textWidth = doc.getStringUnitWidth(t.time) * doc.internal.getFontSize() / doc.internal.scaleFactor; doc.line(cols.time, y - 2, cols.time + textWidth, y - 2); }
            y += 7;
        });

        drawSummaryPage(doc, 'Daily Financial Report', summaryData);
        addFooter(doc);

        const pdfBlob = doc.output('blob');
        const fileName = `Daily-Report-${reportDate}.pdf`;
        downloadDailyBtn.style.display = 'block';
        downloadDailyBtn.onclick = () => downloadPdf(pdfBlob, fileName);
        hideLoading();
    }

    // --- UPDATED: generateMonthlyReport with precise currency alignment ---
    function generateMonthlyReport() {
        const reportMonth = document.getElementById('report-month').value;
        if (!reportMonth) { alert('Please select a month.'); return; }
        showLoading();

        transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        const activeMonthly = transactions.filter(t => t.date.startsWith(reportMonth) && t.status === 'active');
        if (activeMonthly.length === 0) { alert('No active transactions for the selected month.'); hideLoading(); return; }
        
        const formattedMonth = new Date(reportMonth + '-02').toLocaleString('default', { month: 'long', year: 'numeric' });
        
        const dailySummaries = {};
        activeMonthly.forEach(t => { if (!dailySummaries[t.date]) { dailySummaries[t.date] = { date: t.date, income: 0, expenses: 0, net: 0 }; } if (t.type === 'income') dailySummaries[t.date].income += t.amount; else dailySummaries[t.date].expenses += t.amount; });
        const summaryArray = Object.values(dailySummaries).map(s => { s.net = s.income - s.expenses; return s; }).sort((a, b) => a.date.localeCompare(b.date));
        const cancelledCount = transactions.filter(t => t.date.startsWith(reportMonth) && t.status === 'undone').length;
        const summaryData = { date: formattedMonth, totalIncome: 0, totalExpenses: 0, activeCount: activeMonthly.length, cancelledCount, incomeByCategory: {}, expenseByCategory: {} };
        activeMonthly.forEach(t => { if (t.type === 'income') { summaryData.totalIncome += t.amount; summaryData.incomeByCategory[t.category] = (summaryData.incomeByCategory[t.category] || 0) + t.amount; } else { summaryData.totalExpenses += t.amount; summaryData.expenseByCategory[t.category] = (summaryData.expenseByCategory[t.category] || 0) + t.amount; } });

        const doc = new jsPDF();
        let y = drawPageHeader(doc, 'Monthly Financial Report', formattedMonth);
        doc.setDrawColor(...COLOR_LINE); doc.line(PAGE_MARGIN, y, PAGE_WIDTH - PAGE_MARGIN, y); y+= 5;
        
        doc.setFontSize(16); doc.setFont('helvetica', 'bold'); doc.setTextColor(...COLOR_BLACK);
        doc.text('Daily Breakdown:', PAGE_MARGIN, y); y += 8;
        
        // Define separate coordinates for each column's currency and value
        const cols = { date: 20, inc_curr: 60, inc_val: 85, exp_curr: 110, exp_val: 135, net_curr: 160, net_val: 195 };
        const drawMonthlyTableHeader = () => {
            doc.setFontSize(10); doc.setFont('helvetica', 'bold'); doc.setTextColor(...COLOR_BLACK);
            doc.text('Date', cols.date, y);
            doc.text('Income', cols.inc_val, y, {align: 'right'});
            doc.text('Expenses', cols.exp_val, y, {align: 'right'});
            doc.text('Net Profit/Loss', cols.net_val, y, {align: 'right'});
            doc.line(PAGE_MARGIN, y + 2, PAGE_WIDTH - PAGE_MARGIN, y + 2); y += 7;
        };
        drawMonthlyTableHeader();

        summaryArray.forEach(day => {
            if (y > PAGE_HEIGHT - PAGE_MARGIN) { doc.addPage(); y = drawPageHeader(doc, 'Monthly Financial Report', formattedMonth); drawMonthlyTableHeader(); }
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(...COLOR_BLACK);
            doc.text(day.date, cols.date, y);
            
            // Income
            doc.setTextColor(...COLOR_INCOME);
            doc.text(CURRENCY_SYMBOL, cols.inc_curr, y);
            doc.text(day.income.toFixed(2), cols.inc_val, y, {align: 'right'});
            
            // Expenses
            doc.setTextColor(...COLOR_EXPENSE);
            doc.text(CURRENCY_SYMBOL, cols.exp_curr, y);
            doc.text(day.expenses.toFixed(2), cols.exp_val, y, {align: 'right'});
            
            // Net
            doc.setTextColor(...(day.net >= 0 ? COLOR_INCOME : COLOR_EXPENSE));
            doc.text(CURRENCY_SYMBOL, cols.net_curr, y);
            doc.text(day.net.toFixed(2), cols.net_val, y, {align: 'right'});
            y += 7;
        });

        drawSummaryPage(doc, 'Monthly Financial Report', summaryData);
        addFooter(doc);

        const pdfBlob = doc.output('blob');
        const fileName = `Monthly-Report-${reportMonth}.pdf`;
        downloadMonthlyBtn.style.display = 'block';
        downloadMonthlyBtn.onclick = () => downloadPdf(pdfBlob, fileName);
        hideLoading();
    }

    // Set defaults
    document.getElementById('report-date').valueAsDate = new Date();
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    document.getElementById('report-month').value = `${year}-${month}`;
  </script>
</body>
</html>